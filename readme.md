## DB-WM

# 注意事项
```
1.配置文件：所有文件直接python xxx.py即可运行，所有配置部分放到config_file.json中，包括训练、测试、嵌入、提取等所有文件默认的配置都在config_file.json中设置，因此运行时无需增加额外配置。所有文件运行时一定注意文件路径，避免被文件被覆盖。
2.运行顺序：在嵌入和提取之前，需要先运行训练代码和单字符视觉特征替换表生成代码（二者没有先后关系），如果使用已经生成好的训练文件则直接运行嵌入和提取代码即可（需要保证权重文件的正确）。
3.微调：基于之前所给代码，仅需要微调或者不微调即可在其他数据集上使用。微调过程即加载目前权重，简单跑几个epoch（可能需要修改学习率，loss的权重）即可。值得注意的是，一定修改保存权重后的文件名，避免权重被覆盖。（这里为了避免这样的情况发送，在训练文件处做了修改，默认保存权重名为model_best和model_final，分别代表效果最好的和最后一次迭代的文件名），这里的效果最好的定义可以根据需求进行更改。
4.运行环境：代码分成四个模块，分别为水印训练、水印嵌入，水印提取，单字符视觉特征表生成。运行该不同代码前，所有程序均需要在虚拟环境中运行。
5.字符替换：字符替换采用的是单字符视觉特征表，但可以根据需求自己定义，仅需要保证给出表是一个主对角线为1，每行除对角线仅有另外一个值为1元素，矩阵为对称矩阵即可。
6.评测指标：代码中采用了一些评测指标，如果实际使用可以删除
```

# environment setup
```
conda create -n your_name python=3.8.6
pip install -r requirements.txt
```

# 配置文件是./csv_word_modify/data/config_file.json，注意根据项目位置修改路径

# train

```
python train_pk_col.py
注意事项:
1.在此过程中采用，分开训练特征提取模块和最后vpk生成模块，在训练特征提取时冻结cls层，仅通过对比学习缩小差距，在训练cls层时冻结特征提取层，最后再联合训练
2.在此过程中，学习率，损失函数的超参数取值会直接影响最后结果。
3.需要注意的是，在运行训练文件时如果是进行fine-tune，那么进行少量epoch训练即可，避免过拟合。
4.训练过程中，如果使用GPU则必须保证model,dataset,optimizer等都在GPU上，必须统一设备。
```

# wm_insert or wm_extract
```
python wm_insert.py
python wm_extracted.py
仅需要注意权重等路径即可
```